# PostgreSQL Configuration File
# Optimized for: 2 CPU cores, 7.25GB RAM
# Based on MySQL/MariaDB configuration optimization patterns

# ============================================================================
# Basic Settings
# ============================================================================
# Character encoding (PostgreSQL defaults to UTF8, similar to MySQL utf8mb4)
# No explicit setting needed - UTF8 is default and fully supports all characters

# Listen addresses
# Must be '*' to accept connections from other Docker containers
listen_addresses = '*'

# Maximum number of concurrent connections
# Reduced for 2-core system (prevents overload)
# MySQL equivalent: max_connections = 50
max_connections = 50

# Maximum number of prepared transactions
# Should be at least as large as max_connections
max_prepared_transactions = 50

# ============================================================================
# Memory Settings (Optimized for 7.25GB RAM system)
# ============================================================================

# Shared memory buffer pool
# Main cache for data and indexes (similar to MySQL innodb_buffer_pool_size)
# MySQL equivalent: innodb_buffer_pool_size = 1536M (~20% of total RAM)
# PostgreSQL recommendation: 25% of RAM, but we match MySQL's conservative 20%
shared_buffers = 1536MB

# Effective cache size for query planner
# Helps query planner estimate how much memory is available for disk caching
# Should be 50-75% of total RAM (we use 75% = 5.4GB)
effective_cache_size = 5400MB

# Work memory per sort/hash operation per connection
# MySQL equivalent: tmp_table_size = 32M, max_heap_table_size = 32M
# For 50 connections: 32MB * 50 = 1600MB max, but only used during sorts/hashes
work_mem = 32MB

# Maintenance work memory for VACUUM, CREATE INDEX, etc.
# Should be higher than work_mem but used infrequently
# MySQL equivalent: larger temp tables for maintenance
maintenance_work_mem = 256MB

# WAL (Write-Ahead Log) buffers
# Similar to MySQL innodb_log_file_size but different mechanism
# MySQL equivalent: innodb_log_file_size = 128M
wal_buffers = 16MB

# Maximum WAL size before checkpoint forced
# Allows PostgreSQL to spread out checkpoint writes (similar to MySQL log flush behavior)
# MySQL equivalent: innodb_flush_log_at_trx_commit = 1
max_wal_size = 2GB
min_wal_size = 512MB

# ============================================================================
# Checkpoint Settings
# ============================================================================
# Checkpoint completion target (0.0 - 1.0)
# Higher values spread checkpoint I/O over longer period
checkpoint_completion_target = 0.9

# ============================================================================
# Query Tuning
# ============================================================================
# Random page cost (default: 4.0)
# Lower values favor index scans, higher values favor sequential scans
# For SSD, lower value is appropriate; for HDD, keep default
random_page_cost = 1.1

# Effective I/O concurrency
# Number of concurrent I/O operations expected
effective_io_concurrency = 200

# ============================================================================
# Logging Settings
# ============================================================================
# Enable logging
logging_collector = on

# Log directory
log_directory = '/var/log/postgresql'

# Log filename pattern
log_filename = 'postgresql-%Y-%m-%d.log'

# Log slow queries (similar to MySQL slow_query_log)
# MySQL equivalent: slow_query_log = 1, long_query_time = 2
log_min_duration_statement = 2000  # Log queries slower than 2 seconds (in milliseconds)

# Log connection and disconnection
log_connections = on
log_disconnections = on

# Log duration for all statements (useful for monitoring)
# log_duration = on

# Log lock waits
log_lock_waits = on

# ============================================================================
# Networking Settings
# ============================================================================
# Note: connect_timeout is a client-side parameter, not a server-side parameter
# Connection timeout is handled by the client (Django) via connection string options

# Idle in transaction session timeout
# Close idle transactions after timeout (for long-running tasks)
# MySQL equivalent: wait_timeout = 1800, interactive_timeout = 1800
idle_in_transaction_session_timeout = 1800000  # 30 minutes (in milliseconds)

# TCP keepalives
tcp_keepalives_idle = 600
tcp_keepalives_interval = 30
tcp_keepalives_count = 3

# ============================================================================
# Statement Behavior
# ============================================================================
# Statement timeout
# Prevent queries from running too long (in milliseconds)
# MySQL equivalent: max_execution_time (per-query timeout)
statement_timeout = 300000  # 5 minutes

# Lock timeout
lock_timeout = 0  # No timeout (wait indefinitely)

# ============================================================================
# Autovacuum Settings
# ============================================================================
# Enable autovacuum (PostgreSQL's equivalent of MySQL's automatic maintenance)
autovacuum = on

# Autovacuum work memory
autovacuum_work_mem = 128MB

# Autovacuum max workers
autovacuum_max_workers = 2  # Reduced for 2-core system

# ============================================================================
# Other Settings
# ============================================================================
# Time zone
timezone = 'UTC'

# Locale
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'

# Default text search config
default_text_search_config = 'pg_catalog.english'

# Performance impact settings (similar to MySQL performance_schema = OFF)
# PostgreSQL doesn't have equivalent, but we can disable some features if not needed
track_activities = on  # Keep on for monitoring
track_counts = on      # Keep on for autovacuum
track_io_timing = off  # Disable if not needed (slight performance improvement)
track_functions = none # Disable function call tracking if not needed

# Max file descriptor limits (PostgreSQL will warn if too low)
# Should be set at OS level (ulimit -n), but we note it here
# Recommended: at least max_connections * 2
